<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-alpha1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>

        <link rel="stylesheet" type="text/css" href="http://sindresorhus.com/github-markdown-css/github-markdown.css">
        <!-- <link rel="stylesheet" type="text/css" href="http://jasonm23.github.io/markdown-css-themes/avenir-white.css"> -->
    </head>
    <body>
        <div class="markdown-body" id="content" style="height: 100000px; width:700px; margin: 3em auto 6em auto;"></div>
        <script type="text/javascript">

            // get and process qstring
            var q = document.URL.split('?')[1];
            if(q != undefined){
                processFile(q);
            } else {
                console.log("no md file given in querystring. defaulting to index.md");
                processFile('index.md');
            }

            // ajax fetch and show mardown file
            function processFile(url) {
                $.get(url, function(md) {
                    $('div#content').html(marked(md));
                    fixRefs();
                    fixTitle();
                    fixHeight();
                }).fail(function(){
                    var errmsg = "Could not find '"+url+"' :( \n Maybe you should create it?";
                    $('div#content').text(errmsg);
                });
            }

            // change the height of the containing box to 'auto' (this is for scroll-position retaining)
            function fixHeight() {
                $('div#content').css({height: 'auto'});
            }

            // update the page title
            function fixTitle() {
                var title = $('div#content h1').first().text();
                document.title = title;
            }

            // do some magic with links
            function fixRefs() {
                $('a').each(function () {

                    // deal with hrefs (add ? to the beginning of local links)
                    if (this.host === location.host) {
                        // internal
                        var me = $(this);

                        // local link (to section)
                        if (me.attr('href').startsWith('#')) {
                            $(this).css({color: '#c44142'});
                        }
                        else {
                        // local link (to other md file)
                            if (!me.attr('href').startsWith('?') && me.attr('href').endsWith('.md')) {
                                me.attr('href', '?'+me.attr('href'));
                            }

                            $(this).css({color: '#41c482'});
                        }
                        
                    }
                    else {
                        // external
                        var me = $(this);

                        // change target to '_blank' (new tab)
                        me.attr('target', '_blank');
                    }
                });
            }

        </script>
    </body>
</html>